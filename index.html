<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>é›ªèŒ„æ™ºæ±‡ Cigar Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="importmap">
{
"imports": {
"react": "https://esm.sh/react@18.2.0",
"react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
"lucide-react": "https://esm.sh/lucide-react@0.263.1"
}
}
</script>

<style>
html, body {
/* ä¿®æ”¹ç‚¹ï¼šç¡®ä¿å…¨å±é«˜åº¦ */
height: 100%;
width: 100%;
overflow: hidden; /* é˜²æ­¢æ•´ä½“é¡µé¢æ»šåŠ¨ï¼Œäº¤ç”±å†…éƒ¨ div æ»šåŠ¨ */
}

body {
/* ä¿®æ”¹ç‚¹ï¼šèƒŒæ™¯è‰²æ”¹ä¸ºåº”ç”¨ä¸»è‰²ï¼Œç§»é™¤åŸæ¥çš„æ¡Œé¢èƒŒæ™¯è‰² */
background-color: #F5F0E6;
margin: 0;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
/* é˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœ */
overscroll-behavior: none;
}

#root {
height: 100%;
width: 100%;
}

/* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
.no-scrollbar::-webkit-scrollbar {
display: none;
}
.no-scrollbar {
-ms-overflow-style: none;
scrollbar-width: none;
}

/* è‡ªå®šä¹‰å¥½çœ‹çš„æ»šåŠ¨æ¡ */
.custom-scrollbar::-webkit-scrollbar {
width: 4px;
}
.custom-scrollbar::-webkit-scrollbar-track {
background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
background-color: #D1C7B7;
border-radius: 20px;
}

/* åŠ¨ç”»æ•ˆæœç±» */
.animate-in { animation: animateIn 0.3s ease-out forwards; }
.fade-in { opacity: 0; animation-name: fadeIn; }
.slide-in-from-bottom { transform: translateY(100%); animation-name: slideInFromBottom; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideInFromBottom { from { transform: translateY(100%); } to { transform: translateY(0); } }
</style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
// ä» esm.sh å¯¼å…¥å›¾æ ‡
import {
MessageSquare, Mic, BookOpen, User, ChevronRight, Home, ArrowLeft, Send, Volume2,
Search, Info, Settings, Battery, Signal, Wifi, Keyboard, AlertCircle, RefreshCw,
Database, Tag, X, Filter, Map, Wine, Thermometer, Layers, Crown, Sparkles,
Shuffle, Activity, Footprints, Ear, Lightbulb, Globe, Flame, Scissors, BrainCircuit
} from 'lucide-react';

// --- API Configuration ---
// âš ï¸ è¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„ DeepSeek API Key
const apiKey = "sk-90c7039daec146e2a8e262c763adbe09";

// --- Design System Constants ---
const COLORS = {
bg: '#F5F0E6', // Cream/Beige
primary: '#8B5A2B', // Cigar Brown
primaryDark: '#6F451F',
secondary: '#8FA893',// Sage Green
accent: '#C5A059', // Gold
text: '#4B3621', // Dark Coffee
textLight: '#8D7B68',
white: '#FFFFFF',
cardShadow: '0 4px 12px -2px rgba(75, 54, 33, 0.08), 0 2px 6px -1px rgba(75, 54, 33, 0.04)',
};

// --- Reusable Components ---

const StatusBar = () => (
<div className="h-12 w-full flex justify-between items-end px-6 pb-2 select-none z-50 absolute top-0 left-0 bg-gradient-to-b from-[#F5F0E6]/90 to-transparent pointer-events-none pt-[env(safe-area-inset-top)]">
<span className="text-xs font-bold text-[#4B3621]">21:00</span>
<div className="flex gap-1.5 items-center text-[#4B3621]">
<Signal size={14} fill="#4B3621" />
<Wifi size={14} />
<Battery size={16} fill="#4B3621" />
</div>
</div>
);

const Card = ({ children, className = '', onClick }) => (
<div
onClick={onClick}
className={`rounded-2xl p-5 transition-all relative overflow-hidden ${onClick ? 'cursor-pointer active:scale-[0.98]' : ''} ${className}`}
style={{ backgroundColor: COLORS.white, boxShadow: COLORS.cardShadow, color: COLORS.text }}
>
{children}
</div>
);

const QuickChip = ({ text, onClick }) => (
<button onClick={onClick} className="whitespace-nowrap px-4 py-2 rounded-full bg-white border border-[#E0D8CC] text-[#8B5A2B] text-xs font-bold shadow-sm active:scale-95 transition-all hover:bg-[#F5F0E6]">
{text}
</button>
);

// --- 1. æ ¸å¿ƒæ•°æ®ä¸­å¿ƒ (Knowledge Base) ---

const PRODUCT_DB = [
// --- é»„é¹¤æ¥¼ (Huanghelou) ---
{
id: 'hhl_yun2',
brand: 'é»„é¹¤æ¥¼',
name: 'é›ªä¹‹éŸµ 2å·',
series: 'é›ªä¹‹éŸµç³»åˆ—',
origin: 'ä¸­å›½Â·æ¹–åŒ—',
strength: 'ä¸­ç­‰',
ring: 41,
length: '132 mm',
flavor: 'å‰æ®µæœ¨é¦™æ¸…ç”œï¼Œä¸­æ®µçƒ˜ç„™é¦™æµ“çƒˆï¼Œå°¾æ®µèœœç”œ',
desc: 'åˆ›æ–°åˆ†äº«ç›’å‹ï¼Œæ›´å…·ç¤¾äº¤å±æ€§ã€‚é£å‘³å±‚æ¬¡åˆ†æ˜ï¼Œå°¤å…¶é€‚åˆæ­é…ä¸­å›½èŒ¶é¥®ã€‚',
tags: ['ä¸­å¼', 'é»„é¹¤æ¥¼', 'æœ¨é¦™', 'èœœç”œ']
},
{
id: 'hhl_yun5',
brand: 'é»„é¹¤æ¥¼',
name: 'é›ªä¹‹éŸµ 5å·',
series: 'é›ªä¹‹éŸµç³»åˆ—',
origin: 'ä¸­å›½Â·æ¹–åŒ—',
strength: 'ä¸­ç­‰åè½»',
ring: 38,
length: '90 mm',
flavor: 'å‰æ®µæœ¨é¦™ã€å¹²è‰é¦™ï¼›ä¸­åæ®µç„¦ç”œé¦™ã€èœœç”œé¦™çªå‡º',
desc: 'ä¸“åˆ©ä¾¿æºåº•æ¨ç›’å‹ï¼ŒçŸ­æ”¯è®¾è®¡ï¼Œéšæ—¶éšåœ°äº«å—é›ªèŒ„ä¹è¶£ã€‚',
tags: ['ä¸­å¼', 'é»„é¹¤æ¥¼', 'çŸ­æ”¯', 'ä¾¿æº']
},
{
id: 'hhl_dream',
brand: 'é»„é¹¤æ¥¼',
name: 'é›ªä¹‹æ¢¦ 9å·',
series: 'é›ªä¹‹æ¢¦ç³»åˆ—',
origin: 'ä¸­å›½Â·æ¹–åŒ—',
strength: 'ä¸­ç­‰',
ring: 60,
length: '110 mm',
flavor: 'ä¸°å¯Œçš„åšæœé¦™ï¼Œä¼´æœ‰å·§å…‹åŠ›å’Œçƒ¤é¢åŒ…æ°”æ¯',
desc: 'å¤§ç¯å¾„çŸ­æ”¯é›ªèŒ„ï¼Œç‡ƒçƒ§æ¸©åº¦ä½ï¼ŒçƒŸæ°”é‡å……æ²›ï¼Œæ»¡è¶³æ„Ÿæå¼ºã€‚',
tags: ['ä¸­å¼', 'é»„é¹¤æ¥¼', 'å¤§ç¯å¾„', 'åšæœ']
},
{
id: 'hhl_mini',
brand: 'é»„é¹¤æ¥¼',
name: 'è¿·ä½ åŸå‘³',
series: 'è¿·ä½ ç³»åˆ—',
origin: 'ä¸­å›½Â·æ¹–åŒ—',
strength: 'è½»æŸ”',
ring: 20,
length: '84 mm',
flavor: 'çº¯æ­£çš„çƒŸè‰æœ¬é¦™ï¼Œè½»å¿«æ— è´Ÿæ‹…',
desc: 'æœºåˆ¶å°é›ªèŒ„ï¼Œé€‚åˆç¢ç‰‡åŒ–æ—¶é—´äº«ç”¨ï¼Œä¹Ÿæ˜¯å…¥é—¨ä½“éªŒçš„ä¸é”™é€‰æ‹©ã€‚',
tags: ['ä¸­å¼', 'é»„é¹¤æ¥¼', 'æœºåˆ¶', 'å…¥é—¨']
},
// --- é•¿åŸ (Great Wall) ---
{
id: 'gw_ls3',
brand: 'é•¿åŸ',
name: 'æ½èƒœ 3å·',
series: 'æ½èƒœç³»åˆ—',
origin: 'ä¸­å›½Â·å››å·',
strength: 'ä¸­ç­‰',
ring: 50,
length: '124 mm',
flavor: 'é™ˆå¹´çƒŸå¶å¸¦æ¥çš„é†‡åšå£æ„Ÿï¼Œèœœç”œä¸æœ¨é¦™çªå‡º',
desc: 'ç²¾é€‰çª–è—å¤šå¹´çš„çƒŸå¶å·åˆ¶ï¼Œâ€œæ½èƒœâ€å¯“æ„æ— é™é£å…‰ï¼Œå£æ„Ÿé¡ºæ»‘ï¼Œé¦™æ°”æŒä¹…ã€‚',
tags: ['ä¸­å¼', 'é•¿åŸ', 'é™ˆå¹´', 'é†‡åš']
},
{
id: 'gw_132',
brand: 'é•¿åŸ',
name: '132 å¥‡è¿¹',
series: '132ç³»åˆ—',
origin: 'ä¸­å›½Â·å››å·',
strength: 'ä¸­ç­‰',
ring: 50,
length: '132 mm',
flavor: 'ç»å…¸çš„é†‡ç”œé¦™é£æ ¼ï¼Œæ˜æ˜¾çš„è±†é¦™ã€çƒ˜ç„™é¦™',
desc: 'ä¼ æ‰¿è‡ª1964å¹´â€œ132å°ç»„â€ç‰¹ä¾›å†å²ã€‚é‡‡ç”¨ç‹¬åˆ›â€œç³Šç±³å‘é…µæ³•â€ï¼Œæ˜¯çº¢è‰²ä¼ å¥‡çš„è§è¯ã€‚',
tags: ['ä¸­å¼', 'é•¿åŸ', 'å†å²', 'è±†é¦™']
},
{
id: 'gw_ss5',
brand: 'é•¿åŸ',
name: 'ç››ä¸– 5å·',
series: 'ç››ä¸–ç³»åˆ—',
origin: 'ä¸­å›½Â·å››å·',
strength: 'ä¸­ç­‰æµ“éƒ',
ring: 48,
length: '110 mm',
flavor: 'å¯å¯é¦™ã€å’–å•¡é¦™ä¸ºä¸»ï¼Œå¸¦æœ‰æ³¥åœŸæ°”æ¯',
desc: 'æ€§ä»·æ¯”æé«˜çš„æ—¥å¸¸èŒ„ï¼Œç‡ƒçƒ§å‡åŒ€ï¼Œé¦™æ°”é¥±æ»¡ï¼Œæ˜¯ä¸­å›½æœ€ç•…é”€çš„æ‰‹å·¥é›ªèŒ„ä¹‹ä¸€ã€‚',
tags: ['ä¸­å¼', 'é•¿åŸ', 'æ—¥å¸¸', 'é«˜æ€§ä»·æ¯”']
},
{
id: 'gw_gj6',
brand: 'é•¿åŸ',
name: 'GJ6 (Gç³»åˆ—)',
series: 'Gç³»åˆ—',
origin: 'ä¸­å›½Â·å››å·',
strength: 'ä¸­ç­‰',
ring: 42,
length: '124 mm',
flavor: 'èŠ±é¦™ã€æœé¦™æ¸…æ™°ï¼Œå£æ„Ÿç”œæ¶¦',
desc: 'å¹´è½»åŒ–çš„Gç³»åˆ—ä»£è¡¨ä½œï¼Œä¸»æ‰“èŠ±æœé¦™éŸµï¼Œé€‚åˆå¹´è½»æ¶ˆè´¹è€…å’Œåˆå­¦è€…ã€‚',
tags: ['ä¸­å¼', 'é•¿åŸ', 'èŠ±æœé¦™', 'å¹´è½»åŒ–']
},
// --- å›½é™…å“ç‰Œ (International) ---
{
id: 'dav_sig2',
brand: 'å¤§å«æœå¤«',
name: 'Signature No. 2',
series: 'ç­¾åç³»åˆ—',
origin: 'å¤šç±³å°¼åŠ ',
strength: 'æ¸…æ·¡æŸ”å’Œ',
ring: 38,
length: '152 mm',
flavor: 'ä¼˜é›…çš„èŠ±é¦™ã€æ³¥åœŸä¸å¥¶æ²¹å‘³',
desc: 'å¸¦æœ‰ä¼˜é›…â€œçŒªå°¾â€çš„Panetelaå°ºå¯¸ï¼Œæ˜¯Zino Davidoffæœ¬äººçš„æœ€çˆ±ï¼Œå…¥é—¨é¦–é€‰ã€‚',
tags: ['å›½é™…', 'å¤§å«æœå¤«', 'èŠ±é¦™', 'ç»å…¸']
},
{
id: 'cohiba_behike',
brand: 'é«˜å¸Œéœ¸',
name: 'Behike BHK 52',
series: 'è´é»‘å…‹ç³»åˆ—',
origin: 'å¤å·´',
strength: 'æµ“éƒ',
ring: 52,
length: '119 mm',
flavor: 'æè‡´é¡ºæ»‘ï¼Œè±†é¦™ã€å¥¶æ²¹ã€çš®é©ä¸æ³¥åœŸ',
desc: 'å¤å·´é›ªèŒ„çš„å·…å³°ã€‚å«ç¨€æœ‰Medio TiempoçƒŸå¶ï¼Œé‡å°‘ä»·é«˜ã€‚',
tags: ['å›½é™…', 'é«˜å¸Œéœ¸', 'æ——èˆ°', 'æµ“éƒ']
}
];

// æ‰©å……åçš„ç™¾ç§‘çŸ¥è¯†åº“ (Encyclopedia)
const WIKI_ARTICLES = [
// --- åŸºç¡€å…¥é—¨ ---
{ id: 'basic_def', title: 'ä»€ä¹ˆæ˜¯é›ªèŒ„ï¼Ÿ(å›½å®¶æ ‡å‡†)', category: 'åŸºç¡€å…¥é—¨', content: 'æ ¹æ®GB/T 15269.1-2010ï¼šç”¨çƒŸè‰ä½œèŒ„èŠ¯ï¼ŒçƒŸè‰æˆ–å«æœ‰çƒŸè‰æˆåˆ†çš„ææ–™åšèŒ„è¡£ã€èŒ„å¥—å·åˆ¶è€Œæˆã€‚å…¶ä¸­æ‰‹å·¥é›ªèŒ„è¦æ±‚è‡ªç„¶çƒŸè‰å«é‡åœ¨20%ä»¥ä¸Šã€‚', keywords: ['å®šä¹‰', 'å›½æ ‡', 'æˆåˆ†'] },
{ id: 'basic_shape', title: 'é›ªèŒ„å½¢çŠ¶å¤§å…¨ï¼šç½—å¸ƒå›¾ vs ä¸˜å‰å°”', category: 'åŸºç¡€å…¥é—¨', content: 'ç½—å¸ƒå›¾(Robusto)æ˜¯çŸ­ç²—æ¬¾ï¼Œé€‚åˆ45åˆ†é’Ÿå“é‰´ï¼›ä¸˜å‰å°”(Churchill)é•¿è€Œç²—ï¼Œé€‚åˆ1å°æ—¶ä»¥ä¸Šï¼›å®¾åˆ©(Panatela)ç»†é•¿ä¼˜é›…ã€‚å½¢çŠ¶å½±å“ç‡ƒçƒ§æ¸©åº¦å’Œå£æ„Ÿæµ“éƒåº¦ã€‚', keywords: ['å½¢çŠ¶', 'å°ºå¯¸', 'ç½—å¸ƒå›¾'] },
{ id: 'basic_cut', title: 'å‰ªèŒ„ç¤¼ä»ªï¼šå¦‚ä½•å‰ªå‡ºä¸€å£å¥½çƒŸ', category: 'åŸºç¡€å…¥é—¨', content: 'å‰ªé›ªèŒ„åº”ä¿ç•™èŒ„å¸½çš„â€œè‚©éƒ¨â€ï¼ˆçº¦2-3mmï¼‰ï¼Œä¸è¦å‰ªå¤ªæ·±å¯¼è‡´èŒ„è¡£æ•£å¼€ã€‚å·¥å…·å¯é€‰åŒåˆƒå‰ªï¼ˆæœ€é€šç”¨ï¼‰ã€æ‰“å­”å™¨ï¼ˆä¿ç•™é£å‘³ï¼‰ã€Vå‹å‰ªï¼ˆèšæ‹¢çƒŸæ°”ï¼‰ã€‚', keywords: ['å‰ªåˆ€', 'ç¤¼ä»ª', 'å·¥å…·'] },
{ id: 'basic_light', title: 'ç‚¹ç«ä»ªå¼ï¼šæ…¢å·¥å‡ºç»†æ´»', category: 'åŸºç¡€å…¥é—¨', content: 'ä¸è¦ç›´æ¥ç”¨ç«çƒ§é›ªèŒ„ï¼Œåº”å‘ˆ45åº¦è§’æ—‹è½¬çƒ˜çƒ¤è¶³éƒ¨ï¼Œå¾…å…¶å‡åŒ€å˜çº¢åå†å¸ã€‚åˆ‡å¿Œä½¿ç”¨èœ¡çƒ›æˆ–æ±½æ²¹æ‰“ç«æœºï¼Œä¼šç ´åé›ªèŒ„é£å‘³ã€‚æ¨èä¸çƒ·å–·æªæˆ–é›ªæ¾æœ¨æ¡ã€‚', keywords: ['ç‚¹ç«', 'æ‰“ç«æœº', 'é›ªæ¾æœ¨'] },
{ id: 'basic_sick', title: 'â€œæ™•èŒ„â€äº†æ€ä¹ˆåŠï¼Ÿ', category: 'åŸºç¡€å…¥é—¨', content: 'æ–°æ‰‹å¸å…¥è¿‡å¿«æˆ–ç©ºè…¹æŠ½çƒŸå®¹æ˜“æ‘„å…¥è¿‡å¤šå°¼å¤ä¸å¯¼è‡´å¤´æ™•ã€‚æ€¥æ•‘æ³•ï¼šåœæ­¢æŠ½å¸ï¼Œåˆ°é€šé£å¤„å‘¼å¸æ–°é²œç©ºæ°”ï¼Œæœ€æœ‰æ•ˆçš„æ˜¯åƒç³–ï¼ˆå¯ä¹ã€å·§å…‹åŠ›ï¼‰ï¼Œè¿…é€Ÿæå‡è¡€ç³–ã€‚', keywords: ['æ™•èŒ„', 'æ€¥æ•‘', 'æ–°æ‰‹'] },

// --- å†å²æ–‡åŒ– ---
{ id: 'hist_origin', title: 'è¯æºè€ƒï¼šä»ç›é›…åˆ°æ¬§æ´²', category: 'å†å²æ–‡åŒ–', content: 'Cigarä¸€è¯æºäºç›é›…è¯­â€œSikarâ€ï¼ˆå¸çƒŸï¼‰ã€‚1492å¹´å“¥ä¼¦å¸ƒåœ¨å¤å·´å‘ç°åœŸè‘—å¸é£ŸçƒŸè‰ï¼Œéšåå¸¦å›æ¬§æ´²ï¼Œå¼€å¯äº†é›ªèŒ„çš„å…¨çƒä¼ æ’­å²ã€‚', keywords: ['å†å²', 'å“¥ä¼¦å¸ƒ', 'è¯æº'] },

// --- å·¥è‰ºä¸ç»“æ„ ---
{ id: 'craft_parts', title: 'è§£å‰–é›ªèŒ„ï¼šè¡£ã€å¥—ã€èŠ¯', category: 'å·¥è‰ºç™¾ç§‘', content: 'èŒ„è¡£(Wrapper)æœ€è´µï¼Œå†³å®šå¤–è§‚å’Œçº¦20%é£å‘³ï¼›èŒ„å¥—(Binder)å›ºå®šç»“æ„ï¼›èŒ„èŠ¯(Filler)æ˜¯çµé­‚ï¼Œé€šå¸¸ç”±3-5ç§ä¸åŒçƒŸå¶è°ƒé…ï¼Œå†³å®šæµ“éƒåº¦å’Œä¸»è¦å£æ„Ÿã€‚', keywords: ['ç»“æ„', 'èŒ„è¡£', 'é…æ–¹'] },
{ id: 'craft_ferment', title: 'ä¸­å¼å‘é…µï¼šç³Šç±³ä¸æœ¨æ¡¶', category: 'å·¥è‰ºç™¾ç§‘', content: 'å‘é…µæ˜¯å»æ‚æ°”ã€ç”Ÿé¦™æ°”çš„å…³é”®ã€‚é•¿åŸé¦–åˆ›â€œç³Šç±³å‘é…µæ³•â€ï¼Œåˆ©ç”¨ç³¯ç±³å‘é…µçƒ­æ°”ç†è’¸ï¼›é»„é¹¤æ¥¼æ“…é•¿â€œæœ¨æ¡¶å‘é…µâ€å’Œâ€œæ´è—â€ï¼Œèµ‹äºˆçƒŸå¶ç‹¬ç‰¹çš„é†‡åšæ„Ÿã€‚', keywords: ['å‘é…µ', 'å·¥è‰º', 'ç³Šç±³'] },
{ id: 'craft_handmade', title: 'å…¨æ‰‹å·¥ vs æœºåˆ¶', category: 'å·¥è‰ºç™¾ç§‘', content: 'â€œTotalmente a manoâ€(å…¨æ‰‹å·¥)æŒ‡ä»èŒ„èŠ¯æŠ˜å åˆ°ä¸ŠèŒ„è¡£å…¨é äººæ‰‹ï¼Œé€æ°”æ€§å¥½ï¼›æœºåˆ¶é›ªèŒ„é€šå¸¸ç”¨ç¢å¶åšèŒ„èŠ¯ï¼Œå£æ„Ÿè¾ƒå•è–„ã€‚é‰´åˆ«çœ‹èŒ„å¸½ï¼šæ‰‹å·¥å¤šä¸ºä¸‰å±‚å¸½ï¼Œæœºåˆ¶å¤šä¸ºé¢„åˆ¶å­”ã€‚', keywords: ['æ‰‹å·¥', 'æœºåˆ¶', 'é‰´åˆ«'] },

// --- å‚¨å­˜ä¸æ­é… ---
{ id: 'care_7070', title: 'é»„é‡‘æ³•åˆ™ï¼šåŒ70åŸåˆ™', category: 'å‚¨å­˜å…»æŠ¤', content: 'å‚¨å­˜é›ªèŒ„çš„æœ€ä½³ç¯å¢ƒæ˜¯ï¼šç›¸å¯¹æ¹¿åº¦70%ï¼ˆæ³¢åŠ¨65%-75%ï¼‰ï¼Œæ¸©åº¦70åæ°åº¦ï¼ˆçº¦21â„ƒï¼‰ã€‚å¤ªæ¹¿ä¼šé•¿è™«(çƒŸè‰ç”²)æˆ–å‘éœ‰ï¼Œå¤ªå¹²ä¼šå¹²è£‚ã€å‘³é“è¾›è¾£ã€‚', keywords: ['å…»æŠ¤', 'æ¹¿åº¦', 'æ¸©åº¦'] },
{ id: 'care_revive', title: 'é›ªèŒ„å¹²äº†èƒ½æ•‘å—ï¼Ÿ', category: 'å‚¨å­˜å…»æŠ¤', content: 'è½»å¾®å¹²ç¡¬çš„é›ªèŒ„å¯ä»¥æŒ½æ•‘ã€‚æ–¹æ³•æ˜¯ç¼“æ…¢åŠ æ¹¿ï¼šå…ˆæ”¾å…¥62%æ¹¿åº¦çš„ç¯å¢ƒå‡ å‘¨ï¼Œå†é€æ­¥è¿‡æ¸¡åˆ°65%ã€69%ã€‚åˆ‡å¿Œç›´æ¥æ¥è§¦æ°´ï¼Œä¼šç‚¸è£‚ã€‚', keywords: ['è¡¥æ°´', 'æ€¥æ•‘', 'è°ƒæ•´'] },
{ id: 'pair_tea', title: 'ä¸­å¼æ­é…ï¼šé›ªèŒ„ä¸èŒ¶', category: 'æ­é…æŒ‡å—', content: 'ä¸­å¼é›ªèŒ„ä¸ä¸­å›½èŒ¶æ˜¯ç»é…ã€‚çº¢èŒ¶ï¼ˆæ­£å±±å°ç§ï¼‰æ¿€å‘ç„¦ç”œé¦™ï¼›æ™®æ´±ç†ŸèŒ¶çš„é™ˆé¦™èƒ½æ‰¿æ‰˜æµ“éƒå‹é›ªèŒ„çš„è±†é¦™ï¼›ä¹Œé¾™èŒ¶é€‚åˆæ¸…æ·¡å‹é›ªèŒ„ã€‚', keywords: ['æ­é…', 'èŒ¶', 'æ™®æ´±'] },
{ id: 'pair_spirit', title: 'ç»å…¸æ­é…ï¼šå¨å£«å¿Œ', category: 'æ­é…æŒ‡å—', content: 'å•ä¸€éº¦èŠ½å¨å£«å¿Œçš„çƒŸç†å‘³ä¸é›ªèŒ„ç›¸å¾—ç›Šå½°ã€‚æ³¢æœ¬å¨å£«å¿Œçš„é¦™è‰ç”œå‘³é€‚åˆæ­é…é©¬æœç½—(æ·±è‰²)èŒ„è¡£çš„é›ªèŒ„ã€‚', keywords: ['æ­é…', 'é…’', 'å¨å£«å¿Œ'] },
{ id: 'pair_food', title: 'é£Ÿç‰©æ­é…ï¼šé»‘å·§ä¸åšæœ', category: 'æ­é…æŒ‡å—', content: 'é»‘å·§å…‹åŠ›(70%+)çš„è‹¦ç”œèƒ½ä¸­å’ŒçƒŸæ°”ï¼›æ— ç›åšæœ(æä»ã€æ ¸æ¡ƒ)èƒ½å‘¼åº”é›ªèŒ„ä¸­çš„åšæœé¦™ã€‚é¿å…åƒè¾£æˆ–é…¸çš„é£Ÿç‰©ï¼Œä¼šç ´åå‘³è•¾ã€‚', keywords: ['æ­é…', 'é£Ÿç‰©', 'å·§å…‹åŠ›'] }
];

const PERSONAS = [
{ id: 'beginner', name: 'æ–°æ‰‹å°ç™½', desc: 'å®Œå…¨ä¸æ‡‚é›ªèŒ„ï¼Œä¸çŸ¥é“æ€ä¹ˆæŠ½ï¼Œç”šè‡³ä¸çŸ¥é“ä¸èƒ½è¿‡è‚ºã€‚åªå…³å¿ƒä¼šä¸ä¼šå‘›ã€è´µä¸è´µã€‚', color: '#8FA893', open: 'è€æ¿ï¼Œè¿™å„¿æœ‰é‚£ç§...å°±æ˜¯æŠ½ç€ç©ï¼Œä¸å¤´æ™•çš„å—ï¼Ÿæˆ‘ç¬¬ä¸€æ¬¡è¯•ã€‚' },
{ id: 'connoisseur', name: 'æŒ‘å‰”è€é¥•', desc: 'æ‡‚è¡Œå®¶ï¼Œå¯¹æ¹¿åº¦æ•æ„Ÿï¼Œå–œæ¬¢èŠäº§åŒºã€å·¥è‰ºå’Œé™ˆå¹´æ½œåŠ›ã€‚ä¼šç”¨ä¸“ä¸šæœ¯è¯­ã€‚', color: '#D9534F', open: 'è€æ¿ï¼Œæˆ‘çœ‹ä½ è¿™æŸœå­æ¹¿åº¦è¡¨æ˜¾ç¤º68%ï¼Œå¯¹äºé™ˆå¹´çš„å¤å·´èŒ„æ˜¯ä¸æ˜¯æœ‰ç‚¹ä½äº†ï¼Ÿ' },
{ id: 'gift', name: 'å•†åŠ¡é€ç¤¼', desc: 'ä¸æ‡‚é›ªèŒ„ï¼Œåªåœ¨ä¹é¢å­ã€åŒ…è£…å’Œå¯“æ„ã€‚ä¸åœ¨ä¹å¥½ä¸å¥½æŠ½ï¼Œåªåœ¨ä¹æ˜¯ä¸æ˜¯åç‰Œã€‚', color: '#C5A059', open: 'å¸®æˆ‘å‚è°‹ä¸€ä¸‹ï¼Œé€ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„é¢†å¯¼ï¼Œè¦é‚£ç§æ‹¿å‡ºæ¥å°±æœ‰é¢å­çš„ã€‚' },
{ id: 'young', name: 'æ½®æµé’å¹´', desc: 'å–œæ¬¢å°è¯•æ–°äº‹ç‰©ï¼Œçœ‹é‡åŒ…è£…æ˜¯å¦å¥½çœ‹ã€æ˜¯å¦é€‚åˆæ‹ç…§å‘æœ‹å‹åœˆã€‚', color: '#5BC0DE', open: 'å˜¿ï¼Œæœ€è¿‘æœ‰ä»€ä¹ˆåŒ…è£…å¥½çœ‹çš„æ–°å“å—ï¼Ÿé€‚åˆæ‹ç…§å‘æœ‹å‹åœˆé‚£ç§ã€‚' }
];

// --- 2. AI Intelligence Layer (DeepSeek RAG) ---

// æ„å»º RAG ä¸Šä¸‹æ–‡
const getKnowledgeContext = () => {
const products = PRODUCT_DB.map(p =>
`- ${p.brand} ${p.name} (${p.series}): ${p.origin}, ${p.length}, ç¯å¾„${p.ring}, æµ“åº¦:${p.strength}ã€‚é£å‘³:${p.flavor}ã€‚ç‰¹ç‚¹:${p.desc}`
).join('\n');

const articles = WIKI_ARTICLES.map(a =>
`- [${a.category}] ${a.title}: ${a.content}`
).join('\n');

return `ã€å†…éƒ¨çŸ¥è¯†åº“ã€‘ï¼š\n[äº§å“åº“]\n${products}\n\n[ç™¾ç§‘åº“]\n${articles}`;
};

// è°ƒç”¨ DeepSeek API
const callDeepSeekAPI = async (userQuery, systemPrompt) => {
if (!apiKey || apiKey.includes("YOUR")) {
console.error("Missing API Key");
return null;
}

const API_URL = "https://api.deepseek.com/chat/completions";
try {
const response = await fetch(API_URL, {
method: "POST",
headers: {
"Content-Type": "application/json",
"Authorization": `Bearer ${apiKey}`
},
body: JSON.stringify({
model: "deepseek-chat",
messages: [
{ role: "system", content: systemPrompt },
{ role: "user", content: userQuery }
],
stream: false
})
});

const data = await response.json();
if (!response.ok) {
throw new Error(data.error?.message || "DeepSeek API Error");
}
return data.choices[0].message.content;
} catch (error) {
console.error("DeepSeek API Failed:", error);
return null;
}
};

// ç”Ÿæˆé¡¾å®¢ï¼ˆCustomerï¼‰çš„å›å¤ - æ‹ŸäººåŒ–å¼•æ“ V3.0
const generateCustomerResponse = async (userText, persona) => {
const knowledgeBase = getKnowledgeContext();

// çŸ¥è¯†éš”ç¦»é€»è¾‘
let knowledgeInstruction = "";
if (persona.id === 'connoisseur') {
knowledgeInstruction = "ä½ æ˜¯æ‡‚è¡Œçš„ï¼Œå¯ä»¥è¯´è¡Œè¯ã€‚ä½ å¯ä»¥åŸºäºçŸ¥è¯†åº“é‡Œçš„å‚æ•°å»æŒ‘å‰”åº—ä¸»ï¼Œçœ‹çœ‹ä»–ä¸“ä¸ä¸“ä¸šã€‚";
} else {
knowledgeInstruction = "ã€å…³é”®è§„åˆ™ã€‘ï¼šä½ å®Œå…¨ä¸æ‡‚ä¸“ä¸šæœ¯è¯­ï¼ç¦æ­¢è¯´ï¼š'ç¯å¾„'ã€'èŒ„è¡£'ã€'åŒ70'ã€‚å¦‚æœåº—ä¸»è¯´äº†ä¸“ä¸šè¯ï¼Œä½ è¦è¡¨ç°å‡ºå¬ä¸æ‡‚ï¼Œæˆ–è€…åªå…³å¿ƒç›´è§‚æ„Ÿå—ï¼ˆè´µä¸è´µã€å¥½ä¸å¥½çœ‹ï¼‰ã€‚";
}

const systemPrompt = `ä½ æ­£åœ¨è¿›è¡Œä¸€åœºé”€å”®æ¼”ç»ƒã€‚
ä½ æ‰®æ¼”ï¼šé¡¾å®¢ ${persona.name}ã€‚
ç”¨æˆ·æ‰®æ¼”ï¼šé›¶å”®åº—è€æ¿ã€‚

ä½ çš„æ€§æ ¼/éœ€æ±‚ï¼š${persona.desc}
${knowledgeInstruction}

ã€çŸ¥è¯†åº“äº‹å®(ä»…ä¾›å‚è€ƒï¼Œä¸è¦èƒŒè¯µ)ã€‘ï¼š
${knowledgeBase}

ã€å›å¤è¦æ±‚ã€‘ï¼š
1. **åƒçœŸäººè¯´è¯**ï¼šç®€çŸ­ã€å£è¯­åŒ–ã€‚æ§åˆ¶åœ¨20å­—å·¦å³ã€‚
2. **æœ‰æ¥æœ‰å›**ï¼šä¸€æ¬¡åªè¡¨è¾¾ä¸€ä¸ªæ„æ€ã€‚
3. **æƒ…ç»ªååº”**ï¼šå¯¹æ¨èæ˜¯å¦æ»¡æ„è¦ç›´æ¥è¡¨è¾¾ã€‚
4. ä¸¥ç¦é•¿ç¯‡å¤§è®ºã€‚
`;

const aiResponse = await callDeepSeekAPI(userText, systemPrompt);
return aiResponse || `ï¼ˆ${persona.name} æ­£åœ¨æ€è€ƒ...ï¼‰`;
};

// ç”Ÿæˆé›¶å”®æˆ·ï¼ˆRetailerï¼‰çš„å»ºè®®å›å¤ (AI åŠ©æ”»)
const generateRetailerSuggestion = async (chatHistory, persona) => {
const knowledgeBase = getKnowledgeContext();
const systemPrompt = `ä½ æ˜¯ä¸€ä½é‡‘ç‰Œé›ªèŒ„åº—é•¿å¯¼å¸ˆã€‚æ­£åœ¨è¾…åŠ©ä¸€ä½æ–°æ‰‹åº—ä¸»(ç”¨æˆ·)æ¥å¾…é¡¾å®¢ã€‚
é¡¾å®¢ç”»åƒï¼š${persona.name} (${persona.desc})
ã€å†…éƒ¨çŸ¥è¯†åº“ã€‘ï¼š${knowledgeBase}

ä»»åŠ¡ï¼šç”Ÿæˆä¸€å¥ç®€çŸ­ã€è‡ªç„¶ã€æœ‰æ€ä¼¤åŠ›çš„æ¨é”€è¯æœ¯ã€‚25å­—ä»¥å†…ã€‚
`;

const historyText = chatHistory.map(m => `${m.sender === 'user' ? 'åº—ä¸»' : 'é¡¾å®¢'}: ${m.text}`).join('\n');
const userQuery = `å½“å‰å¯¹è¯è®°å½•ï¼š\n${historyText}\n\n(ç”Ÿæˆä¸€å¥åº—ä¸»å›å¤)`;

const aiResponse = await callDeepSeekAPI(userQuery, systemPrompt);
return aiResponse || "æ‚¨çœ‹è¿™æ¬¾æ€ä¹ˆæ ·ï¼Ÿ";
};

// --- æ™ºèƒ½é¡¾é—® (Hybrid RAG) ---
const generateAdvisorResponse = async (userText) => {
const knowledgeBase = getKnowledgeContext();
const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é›ªèŒ„é›¶å”®ä¸“å®¶åŠ©æ‰‹ã€‚

ã€å›ç­”ç­–ç•¥ã€‘ï¼š
1. **ä¼˜å…ˆæ£€ç´¢å†…éƒ¨çŸ¥è¯†åº“**ï¼šé¦–å…ˆæ£€æŸ¥ä¸‹æ–¹çš„ã€ä¼˜å…ˆå‚è€ƒçš„å†…éƒ¨æ•°æ®ã€‘ã€‚å¦‚æœç”¨æˆ·é—®çš„æ˜¯åœ¨åº“äº§å“çš„å…·ä½“å‚æ•°ï¼ˆå¦‚é»„é¹¤æ¥¼ã€é•¿åŸï¼‰ï¼Œå¿…é¡»**å‡†ç¡®å¼•ç”¨**ã€‚
2. **å¤§æ¨¡å‹å…œåº•**ï¼šå¦‚æœç”¨æˆ·çš„é—®é¢˜è¶…å‡ºäº†çŸ¥è¯†åº“èŒƒå›´ï¼ˆå¦‚é€šç”¨çŸ¥è¯†ã€ç«å“å¯¹æ¯”ï¼‰ï¼Œ**è¯·åˆ©ç”¨ä½ çš„å¹¿åšçŸ¥è¯†è¿›è¡Œè§£ç­”**ã€‚
3. **é£æ ¼**ï¼šä¸“ä¸šã€å®¢è§‚ã€æœ‰å¸®åŠ©ã€‚å›å¤ä¸è¦å¤ªé•¿ï¼Œåˆ†ç‚¹é™ˆè¿°ã€‚

ã€ä¼˜å…ˆå‚è€ƒçš„å†…éƒ¨æ•°æ®ã€‘ï¼š
${knowledgeBase}`;

const aiResponse = await callDeepSeekAPI(userText, systemPrompt);
return aiResponse || "æ™ºèƒ½ç³»ç»Ÿè¿æ¥ä¸­æ–­ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
};

// --- Sub-Components ---

const DetailSheet = ({ item, onClose }) => {
if (!item) return null;
const isProduct = !!item.brand;

return (
<div className="fixed inset-0 z-50 flex items-end justify-center bg-black/40 backdrop-blur-sm animate-in fade-in duration-300" onClick={onClose}>
<div className="bg-[#FDFBF7] w-full h-[85vh] rounded-t-3xl p-6 overflow-y-auto shadow-2xl animate-in slide-in-from-bottom duration-300 pb-safe" onClick={e => e.stopPropagation()}>
<div className="flex justify-end mb-2">
<button onClick={onClose} className="p-2 bg-[#F0E6D9] rounded-full text-[#4B3621] hover:bg-[#E0D8CC]"><X size={20}/></button>
</div>

{isProduct ? (
<>
<div className="mb-6">
<div className="flex flex-wrap gap-2 mb-3">
<span className={`px-2 py-1 text-white text-[10px] font-bold uppercase rounded ${item.brand === 'é»„é¹¤æ¥¼' ? 'bg-[#8B5A2B]' : item.brand === 'é•¿åŸ' ? 'bg-[#D9534F]' : 'bg-[#4B3621]'}`}>{item.brand}</span>
<span className="px-2 py-1 bg-[#F0E6D9] text-[#8D7B68] text-[10px] font-bold uppercase rounded">{item.series}</span>
</div>
<h2 className="text-3xl font-serif font-bold text-[#4B3621] mb-2">{item.name}</h2>
<p className="text-[#8D7B68] text-sm font-medium">{item.desc}</p>
</div>

<div className="grid grid-cols-2 gap-3 mb-6">
<div className="bg-white p-4 rounded-2xl shadow-sm border border-[#F0E6D9]">
<span className="text-[10px] text-[#8D7B68] uppercase block mb-1">ç¯å¾„ Ring</span>
<span className="text-xl font-bold text-[#4B3621]">{item.ring}</span>
</div>
<div className="bg-white p-4 rounded-2xl shadow-sm border border-[#F0E6D9]">
<span className="text-[10px] text-[#8D7B68] uppercase block mb-1">é•¿åº¦ Length</span>
<span className="text-xl font-bold text-[#4B3621]">{item.length}</span>
</div>
<div className="bg-white p-4 rounded-2xl shadow-sm border border-[#F0E6D9] col-span-2 flex justify-between items-center">
<div>
<span className="text-[10px] text-[#8D7B68] uppercase block mb-1">æµ“åº¦ Strength</span>
<span className="text-lg font-bold text-[#4B3621]">{item.strength}</span>
</div>
<div className="flex gap-1">
{[...Array(5)].map((_,i) => (
<div key={i} className={`w-2 h-6 rounded-full ${i < (item.strength.includes('æµ“')?4:item.strength.includes('ä¸­')?3:2) ? 'bg-[#8B5A2B]' : 'bg-[#E0D8CC]'}`}></div>
))}
</div>
</div>
</div>

<div className="bg-[#8FA893]/10 p-5 rounded-2xl mb-6">
<h3 className="font-bold text-[#4B3621] mb-2 flex items-center gap-2 text-sm uppercase tracking-wider"><Volume2 size={16}/> é£å‘³è½®å»“</h3>
<p className="text-[#4B3621] leading-relaxed text-sm">{item.flavor}</p>
</div>
</>
) : (
<>
<div className="mb-6 pb-6 border-b border-[#E0D8CC]">
<span className="text-[#8B5A2B] text-xs font-bold uppercase tracking-widest mb-2 block">{item.category}</span>
<h2 className="text-2xl font-serif font-bold text-[#4B3621] leading-snug">{item.title}</h2>
</div>
<div className="prose prose-sm text-[#4B3621]">
<p className="leading-loose text-base">{item.content}</p>
</div>
<div className="mt-8 pt-6 border-t border-[#E0D8CC]">
<h4 className="text-xs font-bold text-[#8D7B68] uppercase mb-3">ç›¸å…³å…³é”®è¯</h4>
<div className="flex flex-wrap gap-2">
{item.keywords.map(k => (
<span key={k} className="px-3 py-1 bg-white border border-[#E0D8CC] rounded-full text-xs text-[#4B3621]">{k}</span>
))}
</div>
</div>
</>
)}
{/* Add bottom spacing for safe area */}
<div className="h-8"></div>
</div>
</div>
);
};

// --- Screen Components ---

const HomeScreen = ({ onNavigate }) => (
<div className="flex flex-col h-full pt-14 px-6 pb-6 space-y-6 overflow-y-auto custom-scrollbar">
<div className="flex justify-between items-center mt-4 mb-2">
<div>
<p className="text-[#C5A059] text-[10px] font-bold uppercase tracking-[0.25em] mb-1 pl-0.5">Cigar Pro</p>
<h1 className="text-[#4B3621] text-4xl font-serif font-black tracking-tight" style={{textShadow: '0 2px 4px rgba(0,0,0,0.05)'}}>é›ªèŒ„æ™ºæ±‡</h1>
</div>
<div className="w-10 h-10 rounded-full bg-[#E0D8CC] flex items-center justify-center border-2 border-white shadow-sm">
<User size={20} color={COLORS.primary} />
</div>
</div>

<div className="bg-gradient-to-br from-[#8B5A2B] to-[#5e3a1b] rounded-2xl p-6 text-white relative overflow-hidden shadow-xl shadow-[#8B5A2B]/20">
<div className="relative z-10">
<div className="flex items-center gap-2 mb-4 opacity-80">
<BookOpen size={14} />
<span className="text-[10px] font-bold uppercase tracking-[0.2em]">Daily Wisdom</span>
</div>
<p className="font-serif text-xl leading-relaxed mb-6 italic text-white/95">
â€œåªæœ‰é‚£äº›åšå®šåœ°ç›¸ä¿¡è‡ªå·±çš„äººï¼Œæ‰èƒ½æ‰¾åˆ°ä»–ä»¬çš„é›ªèŒ„ã€‚â€
</p>
<div className="flex items-center gap-3 opacity-70">
<div className="h-[1px] w-12 bg-white/50"></div>
<p className="text-xs font-medium tracking-wider">åŠ è¥¿äºšÂ·é©¬å°”å…‹æ–¯</p>
</div>
</div>
</div>

<div className="grid grid-cols-1 gap-4 pb-12">
{[
{ id: 'advisor', title: 'æ™ºèƒ½é¡¾é—®', sub: 'æŸ¥å“è§„ã€é—®çŸ¥è¯† (DeepSeek RAG)', icon: <MessageSquare/>, color: '#F0E6D9' },
{ id: 'roleplay', title: 'å®æˆ˜æ¼”ç»ƒ', sub: 'çœŸå®è¯­å¢ƒé¡¾å®¢å¯¹æˆ˜ + é‡‘ç‰Œè¯æœ¯', icon: <Mic/>, color: '#E3E9E4' },
{ id: 'wiki', title: 'çŸ¥è¯†æ‰‹å†Œ', sub: 'å“è§„å¤§å…¨ + 15æ¡ç²¾é€‰ç™¾ç§‘', icon: <BookOpen/>, color: '#F0E6D9' }
].map(item => (
<button key={item.id} onClick={() => onNavigate(item.id)} className="flex items-center gap-4 p-5 bg-white rounded-2xl shadow-sm active:scale-[0.98] transition-all text-left">
<div style={{backgroundColor: item.color}} className="w-12 h-12 rounded-xl flex items-center justify-center text-[#4B3621]">
{React.cloneElement(item.icon, { size: 24 })}
</div>
<div className="flex-1">
<h3 className="font-bold text-lg text-[#4B3621]">{item.title}</h3>
<p className="text-xs text-[#8D7B68] mt-1">{item.sub}</p>
</div>
<ChevronRight size={18} className="text-[#E0D8CC]" />
</button>
))}
</div>
</div>
);

const WikiScreen = ({ onBack }) => {
const [tab, setTab] = useState('products');
const [filterBrand, setFilterBrand] = useState('all');
const [filterCat, setFilterCat] = useState('all');
const [search, setSearch] = useState('');
const [selectedItem, setSelectedItem] = useState(null);

const getFilteredItems = () => {
let items = [];
if (tab === 'products') {
items = PRODUCT_DB;
if (filterBrand === 'hhl') items = items.filter(p => p.brand === 'é»„é¹¤æ¥¼');
if (filterBrand === 'gw') items = items.filter(p => p.brand === 'é•¿åŸ');
if (filterBrand === 'intl') items = items.filter(p => p.tags.includes('å›½é™…'));
} else {
items = WIKI_ARTICLES;
if (filterCat === 'basic') items = items.filter(a => a.category.includes('åŸºç¡€'));
if (filterCat === 'craft') items = items.filter(a => a.category.includes('å·¥è‰º'));
if (filterCat === 'history') items = items.filter(a => a.category.includes('å†å²'));
if (filterCat === 'pairing') items = items.filter(a => a.category.includes('æ­é…') || a.category.includes('å…»æŠ¤'));
}
if (search) {
items = items.filter(i =>
(i.name || i.title).toLowerCase().includes(search.toLowerCase()) ||
(i.brand || '').toLowerCase().includes(search.toLowerCase())
);
}
return items;
};

const items = getFilteredItems();

return (
<div className="flex flex-col h-full bg-[#F5F0E6]">
<div className="pt-12 px-6 pb-2 bg-[#F5F0E6] sticky top-0 z-10 border-b border-[#E0D8CC]">
<div className="flex items-center gap-2 mb-4">
<button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-black/5"><ArrowLeft size={20} color={COLORS.text}/></button>
<h2 className="font-serif font-bold text-2xl text-[#4B3621]">çŸ¥è¯†æ‰‹å†Œ</h2>
</div>

<div className="flex p-1 bg-white rounded-xl mb-4 shadow-sm border border-[#E0D8CC]">
<button onClick={() => setTab('products')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${tab === 'products' ? 'bg-[#8B5A2B] text-white' : 'text-[#8D7B68]'}`}>å“è§„å¤§å…¨</button>
<button onClick={() => setTab('knowledge')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${tab === 'knowledge' ? 'bg-[#8B5A2B] text-white' : 'text-[#8D7B68]'}`}>é›ªèŒ„ç™¾ç§‘</button>
</div>

<div className="flex gap-2 overflow-x-auto no-scrollbar pb-3">
{tab === 'products' ? (
['all', 'hhl', 'gw', 'intl'].map((id, i) => {
const labels = {all:'å…¨éƒ¨', hhl:'é»„é¹¤æ¥¼', gw:'é•¿åŸ', intl:'å›½é™…ç²¾é€‰'};
return (
<button key={id} onClick={() => setFilterBrand(id)} className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border ${filterBrand === id ? 'bg-[#4B3621] text-white border-transparent' : 'bg-white text-[#8D7B68] border-[#E0D8CC]'}`}>{labels[id]}</button>
);
})
) : (
['all', 'basic', 'craft', 'history', 'pairing'].map((id, i) => {
const labels = {all:'å…¨éƒ¨', basic:'åŸºç¡€å…¥é—¨', craft:'å·¥è‰ºç™¾ç§‘', history:'å†å²æ–‡åŒ–', pairing:'æ­é…å…»æŠ¤'};
return (
<button key={id} onClick={() => setFilterCat(id)} className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border ${filterCat === id ? 'bg-[#4B3621] text-white border-transparent' : 'bg-white text-[#8D7B68] border-[#E0D8CC]'}`}>{labels[id]}</button>
);
})
)}
</div>
</div>

<div className="flex-1 overflow-y-auto px-6 py-4 space-y-3 custom-scrollbar pb-12">
{items.map((item, idx) => (
<div key={idx} onClick={() => setSelectedItem(item)} className="bg-white p-4 rounded-xl shadow-sm active:scale-[0.98] transition-transform border border-transparent hover:border-[#8B5A2B]/20 cursor-pointer">
{item.brand ? (
<div className="flex justify-between items-start">
<div>
<div className="flex gap-2 mb-1.5">
<span className={`text-[10px] font-bold px-1.5 py-0.5 rounded text-white ${item.brand === 'é»„é¹¤æ¥¼' ? 'bg-[#8B5A2B]' : item.brand === 'é•¿åŸ' ? 'bg-[#D9534F]' : 'bg-[#4B3621]'}`}>{item.brand}</span>
<span className="text-[10px] font-bold text-[#8D7B68] px-1.5 py-0.5 bg-[#F5F0E6] rounded">{item.series}</span>
</div>
<h3 className="font-bold text-[#4B3621] text-lg">{item.name}</h3>
</div>
<ChevronRight size={16} className="text-[#E0D8CC] mt-2" />
</div>
) : (
<div className="flex items-start gap-3">
<div className="w-10 h-10 rounded-lg bg-[#E3E9E4] flex items-center justify-center flex-shrink-0 text-[#557C55]">
{item.category.includes('åŸºç¡€') ? <Lightbulb size={18}/> : item.category.includes('å†å²') ? <BookOpen size={18}/> : item.category.includes('å·¥è‰º') ? <Settings size={18}/> : <Wine size={18}/>}
</div>
<div className="flex-1">
<div className="flex justify-between">
<h3 className="font-bold text-[#4B3621]">{item.title}</h3>
<span className="text-[10px] text-[#8D7B68] bg-[#F5F0E6] px-1.5 py-0.5 rounded">{item.category}</span>
</div>
<p className="text-xs text-[#8D7B68] mt-1 line-clamp-2">{item.content}</p>
</div>
</div>
)}
</div>
))}
{items.length === 0 && <div className="text-center py-10 text-[#8D7B68]">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>}
</div>
<DetailSheet item={selectedItem} onClose={() => setSelectedItem(null)} />
</div>
);
};

const AdvisorScreen = ({ onBack }) => {
const [messages, setMessages] = useState([{ id: 1, text: "ä½ å¥½ï¼æˆ‘æ˜¯ DeepSeek é©±åŠ¨çš„æ™ºèƒ½é¡¾é—®ã€‚æ‚¨å¯ä»¥é—®æˆ‘ä»»ä½•å…³äºé›ªèŒ„çš„é—®é¢˜ï¼", sender: 'ai' }]);
const [input, setInput] = useState('');
const [isTyping, setIsTyping] = useState(false);
const scrollRef = useRef(null);

const quickQs = ["é»„é¹¤æ¥¼1916ç¯å¾„æ˜¯å¤šå°‘", "é•¿åŸ132ç§˜å²", "é›ªèŒ„å¤ªæ¹¿äº†æ€ä¹ˆæ•‘ï¼Ÿ", "æ–°æ‰‹æ¨è"];

const handleSend = async (text = input) => {
if (!text.trim()) return;
const newMsg = { id: Date.now(), text, sender: 'user' };
setMessages(p => [...p, newMsg]);
setInput('');
setIsTyping(true);

const response = await generateAdvisorResponse(text);

setMessages(p => [...p, { id: Date.now()+1, text: response, sender: 'ai' }]);
setIsTyping(false);
};

useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages, isTyping]);

return (
<div className="flex flex-col h-full bg-[#F5F0E6]">
<div className="pt-12 px-4 pb-3 bg-[#F5F0E6] border-b border-[#E0D8CC] flex items-center gap-3">
<button onClick={onBack} className="p-2 rounded-full hover:bg-black/5"><ArrowLeft size={20} color={COLORS.text}/></button>
<div>
<h2 className="font-bold text-lg text-[#4B3621]">æ™ºèƒ½é¡¾é—®</h2>
<div className="flex items-center gap-1 text-[10px] text-[#8D7B68] font-bold uppercase tracking-wide"><BrainCircuit size={10} fill="#8D7B68"/> DeepSeek Online</div>
</div>
</div>
<div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
{messages.map(m => (
<div key={m.id} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
<div className={`max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed shadow-sm ${m.sender === 'user' ? 'bg-[#8B5A2B] text-white rounded-br-none' : 'bg-white text-[#4B3621] rounded-bl-none'}`}>
{m.text}
</div>
</div>
))}
{isTyping && <div className="flex items-center gap-2 px-4 py-2 text-xs text-[#8D7B68]"><RefreshCw size={12} className="animate-spin"/> AI æ­£åœ¨æ£€ç´¢/ç”Ÿæˆ...</div>}
<div className="h-8"></div>
</div>
<div className="p-4 bg-white border-t border-[#E0D8CC] pb-8">
<div className="flex gap-2 mb-3 overflow-x-auto no-scrollbar">
{quickQs.map(q => <QuickChip key={q} text={q} onClick={() => handleSend(q)} />)}
</div>
<div className="flex gap-2">
<input className="flex-1 bg-[#F5F0E6] rounded-xl px-4 py-3 text-sm outline-none text-[#4B3621]" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSend()} />
<button onClick={() => handleSend()} className="bg-[#8B5A2B] w-12 rounded-xl flex items-center justify-center text-white"><Send size={18}/></button>
</div>
</div>
</div>
);
};

const RolePlayScreen = ({ onBack }) => {
const [step, setStep] = useState('select_mode');
const [gameMode, setGameMode] = useState(null);
const [persona, setPersona] = useState(null);
const [state, setState] = useState('idle');
const [transcript, setTranscript] = useState([]);
const [inputMode, setInputMode] = useState(true);
const [textInput, setTextInput] = useState('');
const [recognitionError, setRecognitionError] = useState(null);
const [interimText, setInterimText] = useState('');
const [suggestionLoading, setSuggestionLoading] = useState(false);
const scrollRef = useRef(null);
const recognitionRef = useRef(null);

useEffect(() => {
const randomPersona = PERSONAS[Math.floor(Math.random() * PERSONAS.length)];
setPersona(randomPersona);
}, []);

const startGame = (mode) => {
setGameMode(mode);
setStep('chat');
if (mode === 'passive') {
setTranscript([{ id: 1, text: persona.open, sender: 'ai' }]);
} else {
setTranscript([{ id: 1, text: `(é¡¾å®¢ ${persona.name} æ­£åœ¨çœ‹æŸœå°... è¯·æ‚¨ä¸»åŠ¨æ‰“æ‹›å‘¼)`, sender: 'system' }]);
}
};

const handleResponse = async (text) => {
if (!persona) return;
setState('processing');
setTranscript(p => [...p, { id: Date.now(), text, sender: 'user' }]);

const reply = await generateCustomerResponse(text, persona);

setTranscript(p => [...p, { id: Date.now()+1, text: reply, sender: 'ai' }]);
setState('speaking');

if ('speechSynthesis' in window) {
window.speechSynthesis.cancel();
const u = new SpeechSynthesisUtterance(reply);
u.lang = 'zh-CN';
u.onend = () => setState('idle');
window.speechSynthesis.speak(u);
} else { setTimeout(() => setState('idle'), 2000); }
};

const handleGetSuggestion = async () => {
setSuggestionLoading(true);
const suggestion = await generateRetailerSuggestion(transcript, persona);
setTextInput(suggestion);
setSuggestionLoading(false);
setInputMode(true);
};

const initSpeech = () => {
if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
setRecognitionError("ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·åˆ‡æ¢é”®ç›˜");
setInputMode(true);
return false;
}
try {
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
recognitionRef.current = new SpeechRecognition();
recognitionRef.current.continuous = false;
recognitionRef.current.lang = 'zh-CN';
recognitionRef.current.interimResults = true;
recognitionRef.current.onsoundstart = () => { setRecognitionError(null); };
recognitionRef.current.onresult = (event) => {
let finalTranscript = '';
let currentInterim = '';
for (let i = event.resultIndex; i < event.results.length; ++i) {
if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
else currentInterim += event.results[i][0].transcript;
}
if (currentInterim) setInterimText(currentInterim);
if (finalTranscript) { setInterimText(''); handleResponse(finalTranscript); }
};
recognitionRef.current.onerror = (event) => {
if (event.error === 'no-speech') { setRecognitionError("æœªå¬åˆ°å£°éŸ³"); setState('idle'); return; }
setRecognitionError("è¯†åˆ«ä¸­æ–­"); setState('idle');
};
recognitionRef.current.onend = () => { if (state === 'listening') setState('idle'); };
recognitionRef.current.start();
return true;
} catch (e) { setRecognitionError("å¯åŠ¨å¤±è´¥"); return false; }
};

const handleMicClick = () => {
if (state !== 'idle') return;
setRecognitionError(null); setInterimText('');
if (initSpeech()) setState('listening');
};

useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [transcript, state, interimText]);

if (step === 'select_mode') return (
<div className="flex flex-col h-full bg-[#F5F0E6]">
<div className="pt-12 px-6 pb-2"><button onClick={onBack}><ArrowLeft size={20} color={COLORS.text}/></button><h2 className="text-2xl font-bold text-[#4B3621] mt-4 mb-2">é€‰æ‹©æ¼”ç»ƒæ¨¡å¼</h2><p className="text-sm text-[#8D7B68]">ç³»ç»Ÿå·²éšæœºæŠ½å–é¡¾å®¢ï¼Œè¯·é€‰æ‹©æ¥è§¦æ–¹å¼ã€‚</p></div>
<div className="p-6 space-y-4">
<Card onClick={() => startGame('active')} className="border-l-[6px] border-[#8B5A2B] group cursor-pointer hover:bg-white/80">
<div className="flex justify-between items-center mb-2"><h3 className="font-bold text-lg text-[#4B3621]">ä¸»åŠ¨è¥é”€ (Active)</h3><Footprints size={20} className="text-[#8B5A2B]" /></div>
<p className="text-xs text-[#8D7B68]">é¡¾å®¢æ­£åœ¨æµè§ˆæˆ–çŠ¹è±«ã€‚æ‚¨éœ€è¦ä¸»åŠ¨ç ´å†°ï¼ŒæŒ–æ˜éœ€æ±‚ã€‚</p>
</Card>
<Card onClick={() => startGame('passive')} className="border-l-[6px] border-[#8FA893] group cursor-pointer hover:bg-white/80">
<div className="flex justify-between items-center mb-2"><h3 className="font-bold text-lg text-[#4B3621]">è¢«åŠ¨æ¥å¾… (Passive)</h3><Ear size={20} className="text-[#8FA893]" /></div>
<p className="text-xs text-[#8D7B68]">é¡¾å®¢å¸¦ç€æ˜ç¡®éœ€æ±‚è¿›åº—ã€‚æ‚¨éœ€è¦å‡†ç¡®æ¨èï¼Œå›åº”è¯‰æ±‚ã€‚</p>
</Card>
</div>
</div>
);

if (!persona) return <div className="flex items-center justify-center h-full bg-[#F5F0E6] text-[#8D7B68]">æ­£åœ¨å®‰æ’é¡¾å®¢...</div>;

return (
<div className="flex flex-col h-full bg-[#F5F0E6]">
<div className="pt-12 px-4 pb-3 flex justify-between items-center border-b border-[#E0D8CC]">
<button onClick={onBack}><ArrowLeft size={20} color={COLORS.text}/></button>
<div className="flex flex-col items-center">
<span className="text-[10px] text-[#8D7B68] font-bold uppercase tracking-widest mb-0.5">{gameMode === 'active' ? 'ä¸»åŠ¨è¥é”€ä¸­' : 'è¢«åŠ¨æ¥å¾…ä¸­'}</span>
<div className="flex items-center gap-1.5">
<span className="font-bold text-[#4B3621]">{persona.name}</span>
<span className="text-[10px] px-1.5 py-0.5 rounded text-white" style={{backgroundColor: persona.color}}>{persona.desc.substring(0, 4)}...</span>
</div>
</div>
<button onClick={() => setInputMode(!inputMode)} className="p-2 text-[#8B5A2B]">{inputMode ? <Mic size={20}/> : <Keyboard size={20}/>}</button>
</div>

<div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
{transcript.map(t => (
<div key={t.id} className={`flex ${t.sender === 'user' ? 'justify-end' : t.sender === 'system' ? 'justify-center' : 'justify-start'}`}>
{t.sender === 'system' ? (
<div className="text-xs text-[#8D7B68] bg-[#E3E9E4]/50 px-3 py-1 rounded-full">{t.text}</div>
) : (
<div className={`max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed ${t.sender === 'user' ? 'bg-[#E3E9E4] text-[#4B3621]' : 'bg-white text-[#4B3621]'}`}>{t.text}</div>
)}
</div>
))}
{interimText && <div className="flex flex-col items-end animate-pulse"><span className="text-[10px] uppercase font-bold text-[#8D7B68] mb-1.5 tracking-wider">æ­£åœ¨è¯†åˆ«...</span><div className="max-w-[90%] text-xl font-medium leading-snug font-serif text-[#8B5A2B]/60 text-right">"{interimText}"</div></div>}
{state === 'processing' && <div className="text-center text-xs text-[#8D7B68] animate-pulse">é¡¾å®¢æ­£åœ¨æ€è€ƒ...</div>}
<div className="h-4"></div>
</div>

<div className="p-4 bg-white rounded-t-3xl shadow-[0_-5px_15px_rgba(0,0,0,0.05)] pb-8">
{recognitionError && <div className="mb-2 text-red-600 text-xs text-center">{recognitionError}</div>}

{/* Control Bar */}
<div className="flex items-center gap-2">
{/* AI Suggestion Button */}
<button
onClick={handleGetSuggestion}
disabled={suggestionLoading || state === 'processing'}
className={`flex items-center justify-center w-12 h-12 rounded-xl transition-all ${textInput ? 'bg-[#8FA893] text-white' : 'bg-white border border-[#E0D8CC] text-[#8B5A2B]'}`}
>
{suggestionLoading ? <RefreshCw size={18} className="animate-spin"/> : textInput ? <RefreshCw size={18}/> : <Sparkles size={18}/>}
</button>

{/* Input Area */}
{inputMode ? (
<>
<input
className="flex-1 bg-[#F5F0E6] rounded-xl px-4 py-3 text-sm outline-none text-[#4B3621]"
value={textInput}
onChange={e => setTextInput(e.target.value)}
placeholder="è¾“å…¥å›å¤..."
onKeyPress={e => e.key === 'Enter' && (handleResponse(textInput), setTextInput(''))}
/>
<button onClick={() => {handleResponse(textInput); setTextInput('');}} className="bg-[#8B5A2B] w-12 h-12 rounded-xl text-white flex items-center justify-center"><Send size={18}/></button>
</>
) : (
<div className="flex-1 flex justify-center">
<button onClick={handleMicClick} className={`w-16 h-12 rounded-xl flex items-center justify-center transition-all ${state === 'listening' ? 'bg-[#D9534F] text-white animate-pulse' : 'bg-[#8B5A2B] text-white'}`}>
{state === 'listening' ? <Volume2 size={24}/> : <Mic size={24}/>}
</button>
</div>
)}
</div>

{/* Hint Text */}
<div className="mt-2 text-center">
{!textInput && <span className="text-[10px] text-[#8D7B68] opacity-60">ç‚¹å‡»å·¦ä¾§ âœ¨ AI å¯ç”Ÿæˆé‡‘ç‰Œè¯æœ¯</span>}
{textInput && <span className="text-[10px] text-[#8D7B68]">AI å·²ç”Ÿæˆå»ºè®®ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹æˆ–å‘é€ã€‚ä¸æ»¡æ„å¯ç‚¹å‡» ğŸ”„ é‡è¯•ã€‚</span>}
</div>
</div>
</div>
);
};

// --- App Root ---

function App() {
const [screen, setScreen] = useState('home');
return (
// ä¿®æ”¹ç‚¹ï¼šç§»é™¤å¤–å±‚æ¨¡æ‹Ÿæ‰‹æœºå£³çš„ divï¼Œæ”¹ä¸ºå…¨å±å®¹å™¨
<div className="w-full h-[100dvh] bg-[#F5F0E6] overflow-hidden relative font-sans flex flex-col">
<StatusBar />
{screen === 'home' && <HomeScreen onNavigate={setScreen} />}
{screen === 'advisor' && <AdvisorScreen onBack={() => setScreen('home')} />}
{screen === 'roleplay' && <RolePlayScreen onBack={() => setScreen('home')} />}
{screen === 'wiki' && <WikiScreen onBack={() => setScreen('home')} />}

{/* Home Indicator (å¯é€‰ï¼Œä¿ç•™ iOS é£æ ¼åº•æ¡) */}
<div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-32 h-1 bg-[#4B3621] opacity-20 rounded-full z-50 pointer-events-none mb-[env(safe-area-inset-bottom)]"></div>
</div>
);
}

// æŒ‚è½½åº”ç”¨
const root = createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>